<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Products - UYEH TECH</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <style>
        /* ========== UYEH TECH - MY PRODUCTS PAGE CSS ========== */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Montserrat', sans-serif;
    background: #0a0a0a;
    color: #fff;
    display: flex;
    min-height: 100vh;
}

/* ========== SIDEBAR ========== */
.sidebar {
    width: 280px;
    background: linear-gradient(180deg, #0f0f0f 0%, #0a0a0a 100%);
    border-right: 1px solid rgba(0, 255, 136, 0.2);
    padding: 30px 0;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
    transition: all 0.3s;
    z-index: 1000;
}

.sidebar-logo {
    padding: 0 30px 30px;
    text-align: center;
    border-bottom: 1px solid rgba(0, 255, 136, 0.2);
}

.sidebar-logo-text {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    font-weight: 900;
    color: #00ff88;
    text-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
}

.sidebar-menu {
    list-style: none;
    padding: 30px 15px;
}

.menu-item {
    margin-bottom: 5px;
}

.menu-link {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 20px;
    color: #d1d5db;
    text-decoration: none;
    border-radius: 12px;
    transition: all 0.3s;
    font-weight: 500;
}

.menu-link:hover,
.menu-link.active {
    background: rgba(0, 255, 136, 0.1);
    color: #00ff88;
    transform: translateX(5px);
}

.menu-icon {
    font-size: 1.3rem;
}

.sidebar-footer {
    padding: 20px 30px;
    border-top: 1px solid rgba(0, 255, 136, 0.2);
    margin-top: auto;
}

.logout-btn {
    width: 100%;
    padding: 12px;
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid rgba(255, 68, 68, 0.3);
    border-radius: 10px;
    color: #ff4444;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Montserrat', sans-serif;
}

.logout-btn:hover {
    background: rgba(255, 68, 68, 0.2);
    transform: scale(1.02);
}

/* ========== MAIN CONTENT ========== */
.main-content {
    flex: 1;
    margin-left: 280px;
    padding: 40px;
    transition: all 0.3s;
    max-width: 1400px;
}

/* ========== PAGE HEADER ========== */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 40px;
    gap: 20px;
    flex-wrap: wrap;
}

.header-content {
    flex: 1;
}

.page-title {
    font-family: 'Playfair Display', serif;
    font-size: 2.5rem;
    color: #00ff88;
    margin-bottom: 10px;
}

.page-subtitle {
    color: #9ca3af;
    font-size: 1.1rem;
}

.header-actions {
    display: flex;
    gap: 15px;
}

/* ========== STATS CARDS ========== */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 136, 0.05));
    border: 1px solid rgba(0, 255, 136, 0.3);
    border-radius: 15px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
}

.stat-icon {
    font-size: 2.5rem;
}

.stat-info {
    flex: 1;
}

.stat-label {
    color: #9ca3af;
    font-size: 0.9rem;
    margin-bottom: 5px;
}

.stat-value {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    font-weight: 900;
    color: #00ff88;
}

/* ========== FILTERS ========== */
.filters-section {
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 136, 0.05));
    border: 1px solid rgba(0, 255, 136, 0.3);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 30px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: flex-end;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.filter-label {
    display: block;
    color: #00ff88;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.filter-select,
.search-input {
    width: 100%;
    padding: 12px 15px;
    background: rgba(0, 255, 136, 0.05);
    border: 1px solid rgba(0, 255, 136, 0.3);
    border-radius: 10px;
    color: #fff;
    font-family: 'Montserrat', sans-serif;
    font-size: 0.95rem;
    transition: all 0.3s;
}

.filter-select:focus,
.search-input:focus {
    outline: none;
    border-color: #00ff88;
    background: rgba(0, 255, 136, 0.1);
}

.search-input::placeholder {
    color: #6b7280;
}

/* ========== VIEW TOGGLE ========== */
.view-toggle {
    display: flex;
    gap: 10px;
    background: rgba(0, 255, 136, 0.05);
    border-radius: 10px;
    padding: 5px;
}

.view-btn {
    padding: 10px 20px;
    background: transparent;
    border: none;
    color: #9ca3af;
    font-size: 1.2rem;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.3s;
}

.view-btn.active {
    background: rgba(0, 255, 136, 0.2);
    color: #00ff88;
}

/* ========== BUTTONS ========== */
.btn {
    padding: 12px 25px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Montserrat', sans-serif;
    font-size: 1rem;
}

.btn-primary {
    background: linear-gradient(135deg, #00b359, #00ff88);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
}

.btn-secondary {
    background: rgba(0, 255, 136, 0.1);
    border: 1px solid rgba(0, 255, 136, 0.3);
    color: #00ff88;
}

.btn-secondary:hover {
    background: rgba(0, 255, 136, 0.2);
}

.btn-small {
    padding: 8px 15px;
    font-size: 0.9rem;
}

.btn-icon {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* ========== PRODUCTS GRID ========== */
.products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
}

.product-card {
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 136, 0.05));
    border: 1px solid rgba(0, 255, 136, 0.3);
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s;
    cursor: pointer;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
}

.product-image {
    width: 100%;
    height: 200px;
    background: linear-gradient(135deg, #00b359, #00ff88);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    position: relative;
    overflow: hidden;
}

.product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.product-content {
    padding: 20px;
}

.product-category {
    color: #9ca3af;
    font-size: 0.85rem;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.product-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 10px;
}

.product-description {
    color: #9ca3af;
    font-size: 0.9rem;
    margin-bottom: 15px;
    line-height: 1.5;
}

.product-meta {
    display: flex;
    gap: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(0, 255, 136, 0.2);
    margin-bottom: 15px;
}

.product-meta-item {
    display: flex;
    align-items: center;
    gap: 5px;
    color: #9ca3af;
    font-size: 0.85rem;
}

.product-meta-value {
    color: #00ff88;
    font-weight: 600;
}

.product-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
}

.product-price {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    color: #00ff88;
    font-weight: 900;
}

/* ========== LIST VIEW ========== */
.products-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.product-list-item {
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 136, 0.05));
    border: 1px solid rgba(0, 255, 136, 0.3);
    border-radius: 15px;
    padding: 20px;
    display: flex;
    gap: 20px;
    align-items: center;
    transition: all 0.3s;
    cursor: pointer;
}

.product-list-item:hover {
    transform: translateX(5px);
    box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
}

.list-image {
    width: 100px;
    height: 100px;
    border-radius: 10px;
    background: linear-gradient(135deg, #00b359, #00ff88);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    flex-shrink: 0;
}

.list-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 10px;
}

.list-content {
    flex: 1;
}

.list-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* ========== EMPTY STATE ========== */
.empty-state {
    text-align: center;
    padding: 80px 20px;
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 136, 0.05));
    border: 1px solid rgba(0, 255, 136, 0.3);
    border-radius: 20px;
}

.empty-icon {
    font-size: 5rem;
    margin-bottom: 20px;
}

.empty-state h3 {
    font-family: 'Playfair Display', serif;
    color: #00ff88;
    font-size: 2rem;
    margin-bottom: 15px;
}

.empty-state p {
    color: #9ca3af;
    margin-bottom: 30px;
    font-size: 1.1rem;
}

/* ========== MODAL ========== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: linear-gradient(135deg, rgba(15, 15, 15, 0.98), rgba(10, 10, 10, 0.98));
    border: 1px solid rgba(0, 255, 136, 0.3);
    border-radius: 20px;
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 30px;
    border-bottom: 1px solid rgba(0, 255, 136, 0.2);
}

.modal-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.8rem;
    color: #00ff88;
}

.modal-close {
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid rgba(255, 68, 68, 0.3);
    color: #ff4444;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    background: rgba(255, 68, 68, 0.2);
}

.modal-body {
    padding: 30px;
}

.modal-section {
    margin-bottom: 30px;
}

.modal-section:last-child {
    margin-bottom: 0;
}

.modal-section-title {
    color: #00ff88;
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 15px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid rgba(0, 255, 136, 0.1);
}

.detail-label {
    color: #9ca3af;
}

.detail-value {
    color: #fff;
    font-weight: 600;
}

.product-image-large {
    width: 100%;
    height: 250px;
    border-radius: 15px;
    background: linear-gradient(135deg, #00b359, #00ff88);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 5rem;
    margin-bottom: 20px;
    overflow: hidden;
}

.product-image-large img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* ========== MOBILE MENU ========== */
.mobile-menu-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #00b359, #00ff88);
    border: none;
    border-radius: 12px;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1001;
    box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
}

/* ========== RESPONSIVE ========== */
@media (max-width: 968px) {
    .sidebar {
        width: 0;
        padding: 0;
        overflow: hidden;
    }

    .sidebar.active {
        width: 280px;
        padding: 30px 0;
    }

    .main-content {
        margin-left: 0;
        padding: 20px;
    }

    .mobile-menu-btn {
        display: flex;
    }

    .page-header {
        flex-direction: column;
    }

    .page-title {
        font-size: 2rem;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .products-grid {
        grid-template-columns: 1fr;
    }

    .filters-section {
        flex-direction: column;
    }

    .filter-group {
        width: 100%;
    }

    .product-list-item {
        flex-direction: column;
        text-align: center;
    }

    .list-actions {
        width: 100%;
    }

    .modal-content {
        margin: 20px;
    }

    .btn {
        width: 100%;
    }
}
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo">
            <div class="sidebar-logo-text">
                <img src="uyehtech logo.png" width="100" height="100" alt="UYEH TECH">
            </div>
        </div>

        <ul class="sidebar-menu">
            <li class="menu-item">
                <a href="dashboard.html" class="menu-link">
                    <span class="menu-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="my-products.html" class="menu-link active">
                    <span class="menu-icon">üõçÔ∏è</span>
                    <span>My Products</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="orders.html" class="menu-link">
                    <span class="menu-icon">üìã</span>
                    <span>Order History</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="settings.html" class="menu-link">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
            </li>
            <li class="menu-item">
                <a href="store.html" class="menu-link">
                    <span class="menu-icon">üõí</span>
                    <span>Browse Store</span>
                </a>
            </li>
        </ul>

        <div class="sidebar-footer">
            <button class="logout-btn" id="logoutBtn">üö™ Logout</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <h1 class="page-title">My Products</h1>
                <p class="page-subtitle">Your purchased digital products and downloads</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary btn-icon" id="refreshBtn">
                    <span>üîÑ</span>
                    <span>Refresh</span>
                </button>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-info">
                    <div class="stat-label">Total Products</div>
                    <div class="stat-value" id="totalProducts">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-info">
                    <div class="stat-label">Total Spent</div>
                    <div class="stat-value" id="totalSpent">$0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üî•</div>
                <div class="stat-info">
                    <div class="stat-label">Downloads</div>
                    <div class="stat-value" id="totalDownloads">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚≠ê</div>
                <div class="stat-info">
                    <div class="stat-label">Recent Purchase</div>
                    <div class="stat-value" id="recentPurchase">-</div>
                </div>
            </div>
        </div>

        <!-- Filters & View Toggle -->
        <div class="filters-section">
            <div class="filter-group">
                <label class="filter-label">Category:</label>
                <select class="filter-select" id="categoryFilter">
                    <option value="all">All Categories</option>
                    <option value="software">Software</option>
                    <option value="ebooks">E-Books</option>
                    <option value="courses">Courses</option>
                    <option value="templates">Templates</option>
                    <option value="music">Music</option>
                    <option value="graphics">Graphics</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Sort by:</label>
                <select class="filter-select" id="sortFilter">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="name">Name: A-Z</option>
                </select>
            </div>
            <div class="filter-group">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search products...">
            </div>
            <div class="view-toggle">
                <button class="view-btn active" data-view="grid" title="Grid View">‚äû</button>
                <button class="view-btn" data-view="list" title="List View">‚ò∞</button>
            </div>
        </div>

        <!-- Products Container -->
        <div class="products-grid" id="productsContainer">
            <!-- Products will be loaded here -->
        </div>
    </main>

    <!-- Product Details Modal -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Product Details</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Product details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ========== UYEH TECH - MY PRODUCTS PAGE JAVASCRIPT ==========

const API_URL = 'https://uyehtechbackend.onrender.com'; // Change to your deployed backend URL

let allProducts = [];
let filteredProducts = [];
let currentView = 'grid';

// ========== INITIALIZE PAGE ==========
document.addEventListener('DOMContentLoaded', function() {
    checkAuth();
    initializeEventListeners();
    loadProducts();
    console.log('‚úÖ My Products page initialized');
});

// ========== CHECK AUTHENTICATION ==========
function checkAuth() {
    const token = localStorage.getItem('token');
    const user = localStorage.getItem('user');
    
    if (!token || !user) {
        window.location.href = 'login.html';
        return null;
    }
    
    try {
        return JSON.parse(user);
    } catch (error) {
        console.error('Error parsing user data:', error);
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
        return null;
    }
}

// ========== INITIALIZE EVENT LISTENERS ==========
function initializeEventListeners() {
    // Mobile menu toggle
    document.getElementById('mobileMenuBtn').addEventListener('click', toggleSidebar);
    
    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', logout);
    
    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', function() {
        loadProducts();
        showNotification('üîÑ Refreshing products...', 'info');
    });
    
    // Modal controls
    document.getElementById('closeModal').addEventListener('click', closeModal);
    
    // Filters
    document.getElementById('categoryFilter').addEventListener('change', applyFilters);
    document.getElementById('sortFilter').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    
    // View toggle
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentView = this.dataset.view;
            displayProducts();
        });
    });
    
    // Close modal on outside click
    document.getElementById('productModal').addEventListener('click', function(e) {
        if (e.target.id === 'productModal') {
            closeModal();
        }
    });
    
    // Close sidebar on outside click (mobile)
    document.addEventListener('click', handleOutsideClick);
}

// ========== LOAD PRODUCTS ==========
async function loadProducts() {
    const token = localStorage.getItem('token');
    
    try {
        // Fetch user's purchased products from orders with detailed info
        const response = await fetch(`${API_URL}/api/orders/detailed`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.orders) {
            // Extract all products from completed orders
            allProducts = [];
            data.orders.forEach(order => {
                if (order.status === 'completed' && order.items) {
                    order.items.forEach(item => {
                        // Add purchase date, order info, and download link to each product
                        allProducts.push({
                            ...item,
                            orderId: order._id,
                            orderReference: order.orderReference,
                            purchaseDate: order.createdAt,
                            orderTotal: order.total,
                            downloadLink: item.downloadLink || '',
                            productId: item.productId || item.id,
                            canDownload: order.canDownload !== false
                        });
                    });
                }
            });
            
            localStorage.setItem('user_products', JSON.stringify(allProducts));
            console.log('‚úÖ Products loaded from server:', allProducts.length);
        } else {
            throw new Error('No orders data returned');
        }
        
    } catch (error) {
        console.error('Error fetching products:', error);
        showNotification('‚ö†Ô∏è Using cached data. Some features may be limited.', 'info');
        
        // Fallback to localStorage
        allProducts = JSON.parse(localStorage.getItem('user_products') || '[]');
    }
    
    filteredProducts = [...allProducts];
    displayProducts();
    updateStats();
}

// ========== DISPLAY PRODUCTS ==========
function displayProducts() {
    const container = document.getElementById('productsContainer');
    
    if (filteredProducts.length === 0) {
        container.className = 'empty-state';
        container.innerHTML = `
            <div class="empty-icon">üõçÔ∏è</div>
            <h3>No Products Yet</h3>
            <p>You haven't purchased any products yet. Browse our store to find amazing digital products!</p>
            <a href="store.html" class="btn btn-primary">Browse Store</a>
        `;
        return;
    }
    
    if (currentView === 'grid') {
        container.className = 'products-grid';
        container.innerHTML = filteredProducts.map(product => `
            <div class="product-card" onclick="viewProductDetails('${product.productId || product.id}')">
                <div class="product-image">
                    ${product.image ? `<img src="${product.image}" alt="${product.title}">` : getCategoryIcon(product.category || 'software')}
                </div>
                <div class="product-content">
                    <div class="product-category">${product.category || 'Digital Product'}</div>
                    <div class="product-title">${product.title}</div>
                    <div class="product-description">${product.description || 'Digital product download'}</div>
                    <div class="product-meta">
                        <div class="product-meta-item">
                            <span>üìÖ</span>
                            <span class="product-meta-value">${formatDateShort(product.purchaseDate)}</span>
                        </div>
                        <div class="product-meta-item">
                            <span>üì¶</span>
                            <span class="product-meta-value">${product.orderReference ? product.orderReference.slice(0, 12) : 'N/A'}</span>
                        </div>
                    </div>
                    <div class="product-footer">
                        <div class="product-price">$${product.price}</div>
                        ${product.canDownload ? `
                            <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); downloadProduct('${product.productId || product.id}', '${product.orderId}')">
                                üî• Download
                            </button>
                        ` : `
                            <button class="btn btn-secondary btn-small" disabled>
                                ‚è≥ Processing
                            </button>
                        `}
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        container.className = 'products-list';
        container.innerHTML = filteredProducts.map(product => `
            <div class="product-list-item" onclick="viewProductDetails('${product.productId || product.id}')">
                <div class="list-image">
                    ${product.image ? `<img src="${product.image}" alt="${product.title}">` : getCategoryIcon(product.category || 'software')}
                </div>
                <div class="list-content">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                        <div class="product-category">${product.category || 'Digital Product'}</div>
                    </div>
                    <div class="product-title">${product.title}</div>
                    <div class="product-description">${product.description || 'Digital product download'}</div>
                    <div class="product-meta" style="border-top: none; padding-top: 10px; margin-bottom: 0;">
                        <div class="product-meta-item">
                            <span>üìÖ</span>
                            <span class="product-meta-value">${formatDateShort(product.purchaseDate)}</span>
                        </div>
                        <div class="product-meta-item">
                            <span>üì¶</span>
                            <span class="product-meta-value">${product.orderReference ? product.orderReference.slice(0, 12) : 'N/A'}</span>
                        </div>
                        <div class="product-meta-item">
                            <span>üí∞</span>
                            <span class="product-meta-value">$${product.price}</span>
                        </div>
                    </div>
                </div>
                <div class="list-actions">
                    ${product.canDownload ? `
                        <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); downloadProduct('${product.productId || product.id}', '${product.orderId}')">
                            üî• Download
                        </button>
                    ` : `
                        <button class="btn btn-secondary btn-small" disabled>
                            ‚è≥ Processing
                        </button>
                    `}
                    <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); viewProductDetails('${product.productId || product.id}')">
                        üìÑ Details
                    </button>
                </div>
            </div>
        `).join('');
    }
}

// ========== UPDATE STATS ==========
function updateStats() {
    const totalProducts = allProducts.length;
    const totalSpent = allProducts.reduce((sum, product) => sum + parseFloat(product.price || 0), 0);
    const totalDownloads = allProducts.length; // Each product counts as one download
    
    // Animate values
    animateValue('totalProducts', 0, totalProducts, 1000);
    animateValue('totalSpent', 0, totalSpent, 1000, '$');
    animateValue('totalDownloads', 0, totalDownloads, 1000);
    
    // Recent purchase
    if (allProducts.length > 0) {
        const sortedProducts = [...allProducts].sort((a, b) => 
            new Date(b.purchaseDate) - new Date(a.purchaseDate)
        );
        const recentDate = new Date(sortedProducts[0].purchaseDate);
        document.getElementById('recentPurchase').textContent = formatDateShort(recentDate);
    } else {
        document.getElementById('recentPurchase').textContent = '-';
    }
}

// ========== ANIMATE VALUE ==========
function animateValue(elementId, start, end, duration, prefix = '') {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const range = end - start;
    const increment = range / (duration / 16);
    let current = start;

    const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
            current = end;
            clearInterval(timer);
        }
        
        if (prefix === '$') {
            element.textContent = '$' + Math.floor(current);
        } else {
            element.textContent = prefix + Math.floor(current);
        }
    }, 16);
}

// ========== APPLY FILTERS ==========
function applyFilters() {
    const categoryFilter = document.getElementById('categoryFilter').value;
    const sortFilter = document.getElementById('sortFilter').value;
    const searchQuery = document.getElementById('searchInput').value.toLowerCase();
    
    // Filter products
    filteredProducts = allProducts.filter(product => {
        // Filter by category
        if (categoryFilter !== 'all' && (product.category || '').toLowerCase() !== categoryFilter) {
            return false;
        }
        
        // Filter by search query
        if (searchQuery) {
            const searchString = `${product.title} ${product.description || ''} ${product.category || ''}`.toLowerCase();
            if (!searchString.includes(searchQuery)) {
                return false;
            }
        }
        
        return true;
    });
    
    // Sort products
    filteredProducts.sort((a, b) => {
        switch (sortFilter) {
            case 'newest':
                return new Date(b.purchaseDate) - new Date(a.purchaseDate);
            case 'oldest':
                return new Date(a.purchaseDate) - new Date(b.purchaseDate);
            case 'price-high':
                return parseFloat(b.price) - parseFloat(a.price);
            case 'price-low':
                return parseFloat(a.price) - parseFloat(b.price);
            case 'name':
                return a.title.localeCompare(b.title);
            default:
                return new Date(b.purchaseDate) - new Date(a.purchaseDate);
        }
    });
    
    displayProducts();
}

// ========== VIEW PRODUCT DETAILS ==========
function viewProductDetails(productId) {
    const product = allProducts.find(p => (p.productId || p.id) === productId);
    if (!product) return;
    
    const modalBody = document.getElementById('modalBody');
    
    modalBody.innerHTML = `
        <div class="product-image-large">
            ${product.image ? `<img src="${product.image}" alt="${product.title}">` : getCategoryIcon(product.category || 'software')}
        </div>
        
        <div class="modal-section">
            <h3 class="modal-section-title">${product.title}</h3>
            <p style="color: #9ca3af; margin-bottom: 20px;">${product.description || 'Digital product'}</p>
        </div>
        
        <div class="modal-section">
            <h3 class="modal-section-title">Purchase Information</h3>
            <div class="detail-row">
                <span class="detail-label">Category:</span>
                <span class="detail-value">${product.category || 'Digital Product'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Price Paid:</span>
                <span class="detail-value">$${product.price}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Purchase Date:</span>
                <span class="detail-value">${formatDate(product.purchaseDate)}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Order Reference:</span>
                <span class="detail-value">${product.orderReference || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">File Size:</span>
                <span class="detail-value">${product.fileSize || 'N/A'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Version:</span>
                <span class="detail-value">${product.version || 'N/A'}</span>
            </div>
        </div>
        
        ${product.downloadLink ? `
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn btn-primary" onclick="downloadProduct('${product.productId || product.id}', '${product.orderId}')">
                    üî• Download Now
                </button>
            </div>
        ` : `
            <div style="margin-top: 30px; text-align: center;">
                <p style="color: #9ca3af; margin-bottom: 15px;">Download link will be available shortly</p>
                <button class="btn btn-secondary" disabled>
                    ‚è≥ Processing
                </button>
            </div>
        `}
    `;
    
    document.getElementById('productModal').classList.add('active');
}

// ========== DOWNLOAD PRODUCT ==========
async function downloadProduct(productId, orderId) {
    const product = allProducts.find(p => (p.productId || p.id) === productId);
    if (!product) {
        showNotification('‚ùå Product not found', 'error');
        return;
    }
    
    const token = localStorage.getItem('token');
    
    try {
        // Track the download on the server
        if (orderId && productId) {
            await fetch(`${API_URL}/api/orders/track-download`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    productId: productId,
                    orderId: orderId
                })
            });
        }
        
        // Handle the download
        if (product.downloadLink) {
            showNotification(`üî• Downloading: ${product.title}`, 'info');
            
            // If it's a Google Drive link, open in new tab
            if (product.downloadLink.includes('drive.google.com')) {
                window.open(product.downloadLink, '_blank');
                showNotification(`‚úÖ Opening download link for: ${product.title}`, 'success');
            } else {
                // For direct file links, trigger download
                const link = document.createElement('a');
                link.href = product.downloadLink;
                link.download = product.title;
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    showNotification(`‚úÖ Download started: ${product.title}`, 'success');
                }, 1000);
            }
        } else {
            showNotification(`‚ö†Ô∏è Download link not available yet for: ${product.title}`, 'info');
        }
        
    } catch (error) {
        console.error('Download error:', error);
        showNotification(`‚ùå Download failed: ${error.message}`, 'error');
    }
}

// ========== CLOSE MODAL ==========
function closeModal() {
    document.getElementById('productModal').classList.remove('active');
}

// ========== FORMAT DATE ==========
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatDateShort(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays}d ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
    
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// ========== GET CATEGORY ICON ==========
function getCategoryIcon(category) {
    const icons = {
        'software': 'üíª',
        'ebooks': 'üìö',
        'courses': 'üéì',
        'templates': 'üé®',
        'music': 'üéµ',
        'graphics': 'üñºÔ∏è'
    };
    return icons[category.toLowerCase()] || 'üì¶';
}

// ========== TOGGLE SIDEBAR (MOBILE) ==========
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('active');
}

// ========== HANDLE OUTSIDE CLICK ==========
function handleOutsideClick(event) {
    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.getElementById('mobileMenuBtn');
    
    if (sidebar && menuBtn) {
        if (!sidebar.contains(event.target) && !menuBtn.contains(event.target)) {
            if (window.innerWidth <= 968 && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        }
    }
}

// ========== LOGOUT ==========
function logout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('user_products');
        localStorage.removeItem('user_orders');
        showNotification('üëã Logged out successfully', 'success');
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 500);
    }
}

// ========== SHOW NOTIFICATION ==========
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    
    const colors = {
        success: 'linear-gradient(135deg, #00b359, #00ff88)',
        error: 'linear-gradient(135deg, #ff4444, #ff6666)',
        info: 'linear-gradient(135deg, #00b359, #00ff88)'
    };
    
    notification.style.cssText = `
        position: fixed;
        top: 30px;
        right: 30px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 18px 25px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4);
        z-index: 10000;
        max-width: 400px;
        font-family: 'Montserrat', sans-serif;
        animation: slideIn 0.3s ease;
    `;
    
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    `;
    document.head.appendChild(style);
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(400px)';
        notification.style.transition = 'all 0.3s ease';
        setTimeout(() => {
            notification.remove();
            style.remove();
        }, 300);
    }, 4000);
}

// ========== HANDLE WINDOW RESIZE ==========
window.addEventListener('resize', function() {
    const sidebar = document.getElementById('sidebar');
    if (sidebar && window.innerWidth > 968) {
        sidebar.classList.remove('active');
    }
});
    </script>
</body>
</html>